package Ejercicio4;

import messagepassing.MailBox;
import messagepassing.Selector;

public class Controlador extends Thread {

	private MailBox buzonSolicitarCaja;
	private MailBox buzonAccederA;
	private MailBox buzonAccederB;
	private MailBox buzonDejarCaja;
	private MailBox buzonPantalla;
	private MailBox[] buzonesClientes;
	private Selector s;
	
	private boolean ocupadaCajaA = false;
	private boolean ocupadaCajaB = false;

	public Controlador(MailBox buzonSolicitarCaja, MailBox accederA, MailBox accederB, MailBox buzonDejarCaja,
			MailBox buzonPantalla, MailBox[] buzonesClientes) {
		this.buzonSolicitarCaja = buzonSolicitarCaja;
		this.buzonAccederA = accederA;
		this.buzonAccederB = accederB;
		this.buzonDejarCaja = buzonDejarCaja;
		this.buzonPantalla = buzonPantalla;
		this.buzonesClientes = buzonesClientes;

		this.s = new Selector();
		s.addSelectable(buzonSolicitarCaja, false);
		s.addSelectable(accederA, false);
		s.addSelectable(accederB, false);
		s.addSelectable(buzonDejarCaja, false);
		s.addSelectable(buzonPantalla, false);

	}

	@Override
	public void run() {
		while (true) {
			buzonSolicitarCaja.setGuardValue(true);
			buzonAccederA.setGuardValue(ocupadaCajaA == false);
			buzonAccederB.setGuardValue(ocupadaCajaB == false);
			buzonDejarCaja.setGuardValue(ocupadaCajaA == true || ocupadaCajaB == true);
			buzonPantalla.setGuardValue(true);

			String id = "";
			String respuesta = "";
			String[] respuestaPorCampos = null;

			switch (s.selectOrBlock()) {
			case 1: {
				id = (String) buzonSolicitarCaja.receive();

				int tiempo = (int) (Math.random() * 9000 + 1000);
				respuesta = tiempo >= 5000 ? "A:" + tiempo : "B:" + tiempo;
				buzonesClientes[Integer.parseInt(id) - 1].send(respuesta);
				break;
			}

			case 2: {
				id = (String) buzonAccederA.receive();
				ocupadaCajaA = true;
				respuesta = "true";
				buzonesClientes[Integer.parseInt(id) - 1].send(Boolean.valueOf(respuesta));
				break;
			}
			case 3: {
				id = (String) buzonAccederB.receive();
				ocupadaCajaB = true;
				respuesta = "true";
				buzonesClientes[Integer.parseInt(id) - 1].send(Boolean.valueOf(respuesta));
				break;
			}
			case 4: {
				respuestaPorCampos = ((String) buzonDejarCaja.receive()).split(":");
				if (respuestaPorCampos[1].equals("A") && ocupadaCajaA == true) {
					ocupadaCajaA = false;
				}
				// sino ser√° la caja B
				else if (ocupadaCajaB == true) {
					ocupadaCajaB = false;
				}
				respuesta = "SI";
				buzonesClientes[Integer.parseInt((respuestaPorCampos[0])) - 1].send(String.valueOf(respuesta));
				break;
			}

			case 5: {
				respuestaPorCampos = ((String) buzonPantalla.receive()).split(":");
				id = respuestaPorCampos[0];
				String caja = respuestaPorCampos[1];
				long tiempo = Long.parseLong(respuestaPorCampos[2]);

				System.out.println("--------------------");
				System.out.println("Persona " + id + " ha usado la caja " + caja);
				System.out.println("Tiempo de pago = " + tiempo);
				System.out.println("Thread.sleep(" + tiempo + ")");
				System.out.println("Persona " + id + " liberando la caja " + caja);
				System.out.println("--------------------");
				break;
			}

			}
		}

	}

}